name: Test

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  TEST_MATCH_ID_1: "8461956309"
  TEST_MATCH_ID_2: "8594217096"
  REPLAY_DIR: ~/dota2/replays

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: false

      - name: Install dependencies
        run: uv sync --group dev

      - name: Lint with ruff
        run: uv run ruff check src/ tests/ dota_match_mcp_server.py

      - name: Type check with mypy
        run: uv run mypy src/ dota_match_mcp_server.py --ignore-missing-imports

      - name: Restore replay cache
        uses: actions/cache@v4
        with:
          path: ~/dota2/replays
          key: replays

      - name: Download missing replays
        run: |
          mkdir -p ~/dota2/replays
          for MATCH_ID in ${{ env.TEST_MATCH_ID_1 }} ${{ env.TEST_MATCH_ID_2 }}; do
            if [ ! -f ~/dota2/replays/${MATCH_ID}.dem ]; then
              echo "Downloading replay ${MATCH_ID}..."
              uv run python -c "
          import asyncio
          from src.utils.replay_downloader import ReplayDownloader
          downloader = ReplayDownloader()
          asyncio.run(downloader.download_replay(${MATCH_ID}))
          "
            else
              echo "Replay ${MATCH_ID} already cached"
            fi
          done

      - name: Verify replay files
        run: |
          for MATCH_ID in ${{ env.TEST_MATCH_ID_1 }} ${{ env.TEST_MATCH_ID_2 }}; do
            REPLAY_FILE=~/dota2/replays/${MATCH_ID}.dem
            if [ ! -f "$REPLAY_FILE" ]; then
              echo "ERROR: Replay file $MATCH_ID not found!"
              exit 1
            fi
            SIZE=$(stat -c%s "$REPLAY_FILE")
            echo "Replay $MATCH_ID size: $SIZE bytes"
            if [ "$SIZE" -lt 100000000 ]; then
              echo "ERROR: Replay file $MATCH_ID too small, likely corrupted"
              exit 1
            fi
          done
          echo "All replay files verified OK"

      - name: Parse replays
        timeout-minutes: 20
        run: |
          echo "Parsing replays with memory monitoring..."
          uv run python << 'EOF'
          import asyncio
          import sys
          import os
          import resource

          def get_memory_mb():
              """Get current memory usage in MB."""
              rusage = resource.getrusage(resource.RUSAGE_SELF)
              return rusage.ru_maxrss / 1024  # Convert KB to MB on Linux

          print(f"Initial memory: {get_memory_mb():.1f} MB", flush=True)

          from python_manta import Parser
          print(f"After importing Parser: {get_memory_mb():.1f} MB", flush=True)

          # Test with just the parser directly
          replay_path = os.path.expanduser("~/dota2/replays/8461956309.dem")
          print(f"Replay file exists: {os.path.exists(replay_path)}", flush=True)
          print(f"Replay size: {os.path.getsize(replay_path) / 1024 / 1024:.1f} MB", flush=True)

          print("Creating Parser instance...", flush=True)
          parser = Parser(replay_path)
          print(f"After creating Parser: {get_memory_mb():.1f} MB", flush=True)

          print("Parsing header only...", flush=True)
          result = parser.parse(header=True)
          print(f"After parsing header: {get_memory_mb():.1f} MB", flush=True)
          print(f"Header: build_num={result.header.build_num}, replay_length={result.header.replay_length}", flush=True)

          print("SUCCESS - basic parsing works!", flush=True)
          EOF

      - name: Run tests
        timeout-minutes: 15
        run: uv run pytest tests/ -v
